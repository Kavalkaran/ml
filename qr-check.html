
<!DOCTYPE html>
<html lang="ml">
<head>
<meta charset="UTF-8">
<title>QR ‡¥ï‡µã‡¥°‡µç ‡¥∏‡µÅ‡¥∞‡¥ï‡µç‡¥∑ ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ï‡µª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  background:#0f172a;
  color:white;
  font-family:'Noto Sans Malayalam',sans-serif;
  text-align:center;
  padding:20px;
}

/* ===== ALERT BLINK ===== */
body.alert{
  animation:blink 1s infinite;
}
@keyframes blink{
  0%{background:#ff0000}
  50%{background:#7a0000}
  100%{background:#ff0000}
}

/* ===== CHOICE ===== */
#choice{
  margin-top:70px;
}
.choice-btn{
  width:100%;
  max-width:320px;
  padding:15px;
  margin:12px auto;
  font-size:1.1rem;
  border:none;
  border-radius:12px;
  cursor:pointer;
  background:#2563eb;
  color:white;
}

/* ===== SCANNER ===== */
#scannerUI{display:none}

#reader{
  max-width:400px;
  margin:auto;
  border:2px solid #334155;
  border-radius:10px;
}

button{
  background:#2563eb;
  color:white;
  border:none;
  padding:10px 15px;
  border-radius:6px;
  margin:5px;
  cursor:pointer;
}

#result{
  background:#1e293b;
  padding:15px;
  border-radius:10px;
  margin-top:20px;
  word-break:break-word;
}

.danger{color:#ef4444}

/* ===== MODAL ===== */
.modal{
  position:fixed;
  inset:0;
  display:none;
  background:rgba(0,0,0,0.8);
  justify-content:center;
  align-items:center;
  z-index:9999;
}
.modal.active{display:flex}

.modal-box{
  background:white;
  color:black;
  padding:20px;
  width:90%;
  max-width:420px;
  border-radius:12px;
}
.modal-box h2{color:red}
.modal-box button{width:100%;margin-top:10px}

@media(max-width:480px){
  h1{font-size:1.5rem}
}
</style>
</head>

<body>

<h1>üì∑ QR ‡¥ï‡µã‡¥°‡µç ‡¥∏‡µÅ‡¥∞‡¥ï‡µç‡¥∑ ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ï‡µª</h1>

<!-- ===== CHOICE SCREEN ===== -->
<div id="choice">
  <button class="choice-btn" onclick="useCamera()">üì∑ ‡¥ï‡µç‡¥Ø‡¥æ‡¥Æ‡¥± ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
  <button class="choice-btn" onclick="useUpload()">üìÅ ‡¥°‡¥ø‡¥µ‡µà‡¥∏‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç</button>
</div>

<!-- ===== SCANNER UI ===== -->
<div id="scannerUI">
  <div id="reader"></div>
  <div>
    <button id="startBtn">‚ñ∂Ô∏è ‡¥∏‡µç‡¥ï‡¥æ‡µª</button>
    <button id="flipBtn" disabled>üîÑ ‡¥ï‡µç‡¥Ø‡¥æ‡¥Æ‡¥±</button>
    <button id="stopBtn">‚èπ ‡¥®‡¥ø‡µº‡¥§‡µç‡¥§‡µÅ‡¥ï</button>
  </div>
  <input type="file" id="fileInput" accept="image/*" hidden>
</div>

<div id="result">QR ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥á‡¥µ‡¥ø‡¥ü‡µÜ ‡¥ï‡¥æ‡¥£‡µÅ‡¥Ç...</div>

<!-- ===== ALERT MODAL ===== -->
<div class="modal" id="alertModal">
  <div class="modal-box">
    <h2>‚ö†Ô∏è ‡¥∏‡µÅ‡¥∞‡¥ï‡µç‡¥∑‡¥æ ‡¥Æ‡µÅ‡¥®‡µç‡¥®‡¥±‡¥ø‡¥Ø‡¥ø‡¥™‡µç‡¥™‡µç</h2>
    <p id="alertType"></p>
    <p id="alertMsg"></p>
    <button id="verifyBtn" style="background:red;color:white">üîç Verify ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</button>
    <button onclick="closeAlert()">‡¥Ö‡¥ü‡¥Ø‡µç‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
  </div>
</div>

<script>
const resultEl=document.getElementById("result");
const alertModal=document.getElementById("alertModal");
const alertType=document.getElementById("alertType");
const alertMsg=document.getElementById("alertMsg");
const verifyBtn=document.getElementById("verifyBtn");

let html5QrCode=new Html5Qrcode("reader");
let cameras=[],camIndex=0,scanning=false;

/* ===== ENTRY OPTIONS ===== */
function useCamera(){
  document.getElementById("choice").style.display="none";
  document.getElementById("scannerUI").style.display="block";
  initCamera();
}

function useUpload(){
  document.getElementById("choice").style.display="none";
  document.getElementById("scannerUI").style.display="block";
  document.getElementById("fileInput").click();
}

/* ===== SECURITY ALERT ===== */
function securityAlert(text){
  const l=text.toLowerCase();
  let t="",m="",danger=false;

  if(l.startsWith("upi://")){
    t="üí∏ UPI ‡¥™‡µá‡¥Ø‡µç‚Äå‡¥Æ‡µÜ‡¥®‡µç‡¥±‡µç";
    m="‡¥á‡¥§‡µç ‡¥™‡¥£‡¥Æ‡¥ü‡¥Ø‡µç‡¥ï‡µç‡¥ï‡¥æ‡¥®‡µÅ‡¥≥‡µç‡¥≥ QR ‡¥Ü‡¥£‡µç. ‡¥â‡¥±‡¥™‡µç‡¥™‡¥ø‡¥≤‡µç‡¥≤‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥§‡µÅ‡¥ü‡¥∞‡¥∞‡µÅ‡¥§‡µç.";
    danger=true;
  }else if(l.match(/\.(apk|exe|zip|pdf|docx?)$/)){
    t="üìÅ ‡¥´‡¥Ø‡µΩ ‡¥°‡µó‡µ∫‡¥≤‡µã‡¥°‡µç";
    m="‡¥à ‡¥´‡¥Ø‡µΩ ‡¥Ö‡¥™‡¥ï‡¥ü‡¥ï‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ç.";
    danger=true;
  }else if(l.startsWith("http")){
    t="üåê ‡¥µ‡µÜ‡¥¨‡µç ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç";
    m="‡¥à ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç ‡¥π‡¥æ‡¥®‡¥ø‡¥ï‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ç.";
    danger=true;
  }

  if(danger){
    document.body.classList.add("alert");
    alertType.innerHTML="<strong>QR ‡¥§‡¥∞‡¥Ç:</strong> "+t;
    alertMsg.innerText=m;
    verifyBtn.onclick=()=>window.open(
      "https://kavalkaran-malayalam.onrender.com/spam-check?url="+
      encodeURIComponent(text),"_blank"
    );
    alertModal.classList.add("active");
  }
}

function closeAlert(){
  alertModal.classList.remove("active");
  document.body.classList.remove("alert");
}

function showResult(text){
  resultEl.innerHTML="<strong>QR ‡¥ï‡¥£‡µç‡¥ü‡µÜ‡¥§‡µç‡¥§‡¥ø:</strong><br>"+text;
  securityAlert(text);
}

/* ===== CAMERA ===== */
async function initCamera(){
  try{
    cameras=await Html5Qrcode.getCameras();
    document.getElementById("flipBtn").disabled=cameras.length<=1;
  }catch{
    resultEl.innerHTML="<p class='danger'>‡¥ï‡µç‡¥Ø‡¥æ‡¥Æ‡¥± ‡¥≤‡¥≠‡µç‡¥Ø‡¥Æ‡¥≤‡µç‡¥≤</p>";
  }
}

async function startScan(){
  if(scanning) return;
  scanning=true;
  await html5QrCode.start(
    {deviceId:cameras[camIndex].id},
    {fps:10,qrbox:250},
    txt=>{stopScan();showResult(txt);}
  );
}

async function stopScan(){
  if(!scanning) return;
  scanning=false;
  try{await html5QrCode.stop();}catch{}
}

/* ===== FILE UPLOAD (FIXED) ===== */
document.getElementById("fileInput").addEventListener("change",async e=>{
  const file=e.target.files[0];
  if(!file) return;

  resultEl.innerHTML="üîç QR ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ...";
  try{
    const tempQr=new Html5Qrcode("reader");
    const txt=await tempQr.scanFile(file,true);
    showResult(txt);
  }catch{
    resultEl.innerHTML="<p class='danger'>‚ùå QR ‡¥ï‡¥£‡µç‡¥ü‡µÜ‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥ø‡¥≤‡µç‡¥≤. ‡¥µ‡µç‡¥Ø‡¥ï‡µç‡¥§‡¥Æ‡¥æ‡¥Ø ‡¥ö‡¥ø‡¥§‡µç‡¥∞‡¥Ç ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.</p>";
  }finally{
    e.target.value="";
  }
});

document.getElementById("startBtn").onclick=startScan;
document.getElementById("stopBtn").onclick=stopScan;
document.getElementById("flipBtn").onclick=()=>{
  camIndex=(camIndex+1)%cameras.length;
  stopScan();startScan();
};
</script>
<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
</body>
</html>
